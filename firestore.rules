rules_version = '2';
// Last updated: 2024-12-27
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner() {
      return isSignedIn() && request.auth.uid == resource.data.userId;
    }

    // Check if user is owner using ownerUid field (for photos/stories)
    function isOwnerByUid() {
      return isSignedIn() && (
        request.auth.uid == resource.data.ownerUid ||
        request.auth.uid == resource.data.userId ||
        request.auth.uid == resource.data.authorId
      );
    }

    function isAdmin() {
      return isSignedIn()
        && exists(/databases/$(database)/documents/profiles/$(request.auth.uid))
        && (
          get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.isAdmin == true ||
          get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.role == "admin" ||
          get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.role == "administrator" ||
          get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.membershipTier == "isAdmin"
        );
    }

    // Check if user is a moderator (can moderate content but not full admin)
    function isModerator() {
      return isSignedIn()
        && exists(/databases/$(database)/documents/profiles/$(request.auth.uid))
        && (
          get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.isModerator == true ||
          get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.role == "moderator"
        );
    }

    // Check if user can moderate content (is admin OR moderator)
    function canModerateContent() {
      return isAdmin() || isModerator();
    }

    function isSubscribed() {
      return isSignedIn()
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.subscriptionStatus == 'active';
    }

    // Users collection
    match /users/{userId} {
      allow read: if isSignedIn() || isAdmin();
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if isSignedIn() && (request.auth.uid == userId || isAdmin());
      allow delete: if isSignedIn() && request.auth.uid == userId;

      // Favorite Parks subcollection
      match /favoriteParks/{parkId} {
        allow read: if isSignedIn() && request.auth.uid == userId;
        allow create, update, delete: if isSignedIn() && request.auth.uid == userId;
      }

      // Saved Places subcollection (custom campgrounds)
      match /savedPlaces/{placeId} {
        allow read: if isSignedIn() && request.auth.uid == userId;
        allow create, update, delete: if isSignedIn() && request.auth.uid == userId;
      }

      // Trips subcollection
      match /trips/{tripId} {
        allow read: if isSignedIn() && request.auth.uid == userId;
        allow create, update, delete: if isSignedIn() && request.auth.uid == userId;
      }
    }

    // Profiles collection
    match /profiles/{userId} {
      allow read: if isSignedIn();
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update, delete: if isSignedIn() && request.auth.uid == userId;
    }

    // Trips collection
    match /trips/{tripId} {
      // Owner or trip member can read
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.userId ||
        request.auth.uid in resource.data.memberIds
      );
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.userId;
      // Only owner can update or delete
      allow update, delete: if isSignedIn() && request.auth.uid == resource.data.userId;

      // Participants subcollection - trip owner can manage
      match /participants/{participantId} {
        allow read: if isSignedIn();
        allow create, update, delete: if isSignedIn() && 
          get(/databases/$(database)/documents/trips/$(tripId)).data.userId == request.auth.uid;
      }

      // Packing list subcollection - trip owner or members can manage
      match /packingList/{itemId} {
        allow read, write: if isSignedIn() && (
          get(/databases/$(database)/documents/trips/$(tripId)).data.userId == request.auth.uid ||
          request.auth.uid in get(/databases/$(database)/documents/trips/$(tripId)).data.memberIds
        );
      }

      // Meals subcollection - trip owner or members can manage
      match /meals/{mealId} {
        allow read, write: if isSignedIn() && (
          get(/databases/$(database)/documents/trips/$(tripId)).data.userId == request.auth.uid ||
          request.auth.uid in get(/databases/$(database)/documents/trips/$(tripId)).data.memberIds
        );
      }
    }

    // Tips (legacy)
    match /tips/{id} {
      allow read: if true; // Public read
      allow create: if isSignedIn();
      allow update: if isSignedIn(); // Allow signed-in users to update (for voting)
      // Owner, admin, or moderator can delete
      allow delete: if isOwner() || canModerateContent();
      
      // Votes subcollection
      match /votes/{oderId} {
        allow read: if true;
        allow create, update: if isSignedIn() && request.auth.uid == oderId;
        allow delete: if isSignedIn() && request.auth.uid == oderId;
      }
    }

    // Community Tips (current)
    match /communityTips/{id} {
      allow read: if true; // Public read
      allow create: if isSignedIn();
      allow update: if isSignedIn(); // Allow signed-in users to update (for voting)
      // Owner, admin, or moderator can delete
      allow delete: if isOwner() || canModerateContent();
      
      // Votes subcollection
      match /votes/{oderId} {
        allow read: if true;
        allow create, update: if isSignedIn() && request.auth.uid == oderId;
        allow delete: if isSignedIn() && request.auth.uid == oderId;
      }
    }

    match /tipComments/{id} {
      allow read: if true; // Public read
      allow create: if isSignedIn();
      // Owner, admin, or moderator can update/delete
      allow update, delete: if isOwner() || canModerateContent();
    }

    // Gear Reviews
    match /gearReviews/{id} {
      allow read: if true; // Public read
      allow create: if isSignedIn();
      allow update: if isSignedIn(); // Allow signed-in users to update (for voting)
      // Owner, admin, or moderator can delete
      allow delete: if isOwner() || canModerateContent();
      
      // Votes subcollection
      match /votes/{oderId} {
        allow read: if true;
        allow create, update: if isSignedIn() && request.auth.uid == oderId;
        allow delete: if isSignedIn() && request.auth.uid == oderId;
      }
    }


    // Questions and Answers
    match /questions/{id} {
      allow read: if true; // Public read
      allow create: if isSignedIn();
      allow update: if isSignedIn(); // Allow signed-in users to update (for voting)
      // Owner, admin, or moderator can delete
      allow delete: if isOwner() || canModerateContent();

      // Answers subcollection
      match /answers/{answerId} {
        allow read: if true;
        allow create: if isSignedIn();
        // Owner, admin, or moderator can update/delete
        allow update, delete: if isOwner() || canModerateContent();
      }

      // Comments subcollection (if used)
      match /comments/{commentId} {
        allow read: if true;
        allow create: if isSignedIn();
        // Owner, admin, or moderator can update/delete
        allow update, delete: if isOwner() || canModerateContent();
      }
      
      // Votes subcollection
      match /votes/{oderId} {
        allow read: if true;
        allow create, update: if isSignedIn() && request.auth.uid == oderId;
        allow delete: if isSignedIn() && request.auth.uid == oderId;
      }
    }

    match /answers/{id} {
      allow read: if true; // Public read
      allow create: if isSignedIn();
      // Owner, admin, or moderator can update/delete
      allow update, delete: if isOwner() || canModerateContent();
    }

    // Stories (Photos)
    match /stories/{id} {
      allow read: if true; // Public read
      allow create: if isSignedIn();
      allow update: if isSignedIn(); // Allow signed-in users to update (for voting)
      // Owner, admin, or moderator can delete (using flexible owner check)
      allow delete: if isOwnerByUid() || canModerateContent();
      
      // Votes subcollection
      match /votes/{oderId} {
        allow read: if true;
        allow create, update: if isSignedIn() && request.auth.uid == oderId;
        allow delete: if isSignedIn() && request.auth.uid == oderId;
      }
    }

    // Photos collection (alternate photo storage)
    match /photos/{id} {
      allow read: if true; // Public read
      allow create: if isSignedIn();
      allow update: if isSignedIn(); // Allow signed-in users to update (for voting)
      // Owner, admin, or moderator can delete
      allow delete: if isOwnerByUid() || canModerateContent();
    }

    // Photo Posts collection (enhanced community photos with post types, tags)
    match /photoPosts/{id} {
      allow read: if true; // Public read
      allow create: if isSignedIn();
      allow update: if isSignedIn(); // Allow signed-in users to update (for helpful count)
      // Owner, admin, or moderator can delete
      allow delete: if isOwnerByUid() || canModerateContent();
      
      // Helpful reactions subcollection
      match /helpful/{helpfulUserId} {
        allow read: if true;
        allow create, update: if isSignedIn() && request.auth.uid == helpfulUserId;
        allow delete: if isSignedIn() && request.auth.uid == helpfulUserId;
      }
      
      // Comments subcollection (for future use)
      match /comments/{commentId} {
        allow read: if true;
        allow create: if isSignedIn();
        // Owner, admin, or moderator can update/delete
        allow update, delete: if isOwner() || canModerateContent();
      }
    }

    // Moderation logs - admins and moderators can read/create, never modify
    match /moderationLogs/{id} {
      allow read: if canModerateContent();
      allow create: if canModerateContent();
      allow update, delete: if false; // Immutable audit log
    }

    match /storyComments/{id} {
      allow read: if true; // Public read
      allow create: if isSignedIn();
      // Owner, admin, or moderator can update/delete
      allow update, delete: if isOwner() || canModerateContent();
    }

    match /storyVotes/{id} {
      allow read: if true; // Public read
      allow create: if isSignedIn();
      // Owner, admin, or moderator can update/delete
      allow update, delete: if isOwner() || canModerateContent();
    }

    // Feedback - READ is public, WRITE requires Pro subscription
    match /feedbackPosts/{id} {
      allow read: if true; // Public read - all users can view feedback
      allow create: if isSubscribed() || isAdmin(); // Only Pro users can create feedback
      allow update: if isSubscribed() || isAdmin(); // Only Pro users can update (for voting)
      // Owner, admin, or moderator can delete
      allow delete: if isOwner() || canModerateContent();
      
      // Votes subcollection - requires Pro subscription
      match /votes/{voterId} {
        allow read: if true;
        allow create, update: if (isSubscribed() || isAdmin()) && request.auth.uid == voterId;
        allow delete: if isSignedIn() && request.auth.uid == voterId;
      }
    }

    // Feedback collection (alternate name used by some services)
    match /feedback/{id} {
      allow read: if true; // Public read
      allow create: if isSubscribed() || isAdmin();
      allow update: if isSubscribed() || isAdmin();
      // Owner, admin, or moderator can delete
      allow delete: if isOwner() || canModerateContent();
      
      // Votes subcollection - requires Pro subscription
      match /votes/{voterId} {
        allow read: if true;
        allow create, update: if (isSubscribed() || isAdmin()) && request.auth.uid == voterId;
        allow delete: if isSignedIn() && request.auth.uid == voterId;
      }
    }

    match /feedbackComments/{id} {
      allow read: if true; // Public read - all users can view comments
      allow create: if isSubscribed() || isAdmin(); // Only subscribed users can comment
      // Owner, admin, or moderator can update/delete
      allow update, delete: if isOwner() || canModerateContent();
    }

    // Parks / Campgrounds (public browsing)
    match /parks/{id} {
      allow read: if true; // Public read - anyone can browse parks
      allow create: if isSignedIn(); // Signed-in users can add parks
      allow update, delete: if isOwner() || isAdmin();
    }

    // Campground Contacts (My Campground)
    match /campgroundContacts/{id} {
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.ownerId ||
        request.auth.uid == resource.data.contactUserId
      );
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.ownerId;
      allow update, delete: if isSignedIn() && request.auth.uid == resource.data.ownerId;
    }

    // Campground Invites (managed by Cloud Functions)
    // Inviter can read their own invites, recipients can query by token
    match /campgroundInvites/{id} {
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.inviterUid ||
        request.auth.uid == resource.data.acceptedUid
      );
      // Write operations are handled by Cloud Functions only
      allow create, update, delete: if false;
    }

    // User Gear (Gear Closet)
    match /userGear/{id} {
      allow read: if isSignedIn() && request.auth.uid == resource.data.ownerId;
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.ownerId;
      allow update, delete: if isSignedIn() && request.auth.uid == resource.data.ownerId;
    }

    // Email Subscribers
    match /emailSubscribers/{userId} {
      allow read: if isSignedIn() && request.auth.uid == userId;
      allow write: if isSignedIn() && request.auth.uid == userId;
    }

    // Push Tokens
    match /pushTokens/{tokenId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && request.auth.uid == request.resource.data.userId;
    }

    // Notification Queue (read by owner, write by functions only)
    match /notificationQueue/{notificationId} {
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow create, update, delete: if false; // Functions only
    }

    // ============================================
    // LEARNING CONTENT COLLECTIONS
    // ============================================

    // Learning Tracks - readable by all signed-in users, writable by admins
    match /learningTracks/{trackId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    // Learning Modules - readable by all signed-in users, writable by admins
    match /learningModules/{moduleId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    // User Learning Progress - stored under users subcollection
    match /users/{userId}/learningProgress/{docId} {
      allow read: if isSignedIn() && request.auth.uid == userId;
      allow create, update: if isSignedIn() && request.auth.uid == userId;
      allow delete: if isSignedIn() && request.auth.uid == userId;
    }

    // Reports collection - users can create, admins/mods can read and manage
    match /reports/{reportId} {
      allow read: if canModerateContent();
      allow create: if isSignedIn();
      allow update, delete: if canModerateContent();
    }

    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
